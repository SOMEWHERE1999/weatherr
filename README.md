# weatherr

实时AQI抓取与城市排行榜示例，采用 MVC 分层与 Streamlit 页面。展示城市空气质量排行、可视化与趋势对比，并将每个城市的月度 AQI 保存为单独 CSV 文件。

## 代码架构
```
.
├── app.py                     # Streamlit 入口，负责页面布局、交互配置与调用控制器
├── aqi_app/
│   ├── controller/
│   │   └── aqi_controller.py  # 协调模型与视图：触发抓取、汇总结果、整理可视化数据
│   ├── model/
│   │   └── aqi_model.py       # 数据层：HTTP 抓取、解析、示例数据回退、CSV 持久化
│   └── view/
│       └── aqi_view.py        # 展示层：表格、指标、柱状图、折线图、下拉交互
├── data/                      # 运行后生成，每城一份 monthly CSV
└── requirements.txt           # 依赖声明
```
- **入口(app.py)**：设置页面元信息，读取侧边栏配置（城市数量、排行榜数量），调用控制器加载与汇总数据，再逐步渲染各视图模块。
- **控制器(AQIController)**：封装数据加载流程；拉取城市列表与月度数据，转换为 DataFrame，并提供排序/汇总接口供视图使用。
- **模型(AQIModel)**：
  - 按 `robots.txt` 合规访问站点首页与城市月度页，使用 requests + BeautifulSoup 抓取/解析。
  - 若请求失败或无数据则使用内置示例数据，保证离线可用。
  - 将月度数据写入 `data/monthly/<城市>.csv`，下次运行可直接复用。
- **视图(aqi_view)**：基于 Streamlit + Altair 的组件化渲染：数据表、指标卡、柱状图、单城趋势、月份 Top20、两城对比。

## 配置要求
- Python 3.10+（依赖 `pathlib` 类型提示等特性）。
- 需联网访问 `https://www.aqistudy.cn` 才能抓取实时数据；离线时自动使用示例数据。
- 默认将数据写入 `data/monthly` 目录，可通过 `AQIModel(data_dir=...)` 自定义路径。
- 如需代理或自定义 UA，可在实例化 `requests.Session` 后调整 `headers` 或代理设置。

安装依赖：
```bash
pip install -r requirements.txt
```

## 运行步骤
1. 启动应用：
   ```bash
   streamlit run app.py
   ```
2. 在侧边栏调整“城市数量”“排行数量”，待“正在抓取数据并解析...”完成后即可看到表格与图表。
3. 页面内可选择城市或月份进行趋势/对比，或展开“查看返回内容片段”查看抓取的 HTML 片段。

## 实现的功能
- **实时抓取与合规模拟**：请求前读取 `robots.txt`，每次抓取间隔 `time.sleep(1)`；失败时回退示例数据确保体验完整。
- **城市排行与摘要**：解析城市 AQI，生成 DataFrame，输出空气质量最佳/最差城市及 TopN 排行表。
- **月度数据持久化**：逐城抓取月度 AQI 并写入 CSV，供趋势与对比图复用。
- **多视图可视化**：
  - 数据表与指标卡：快速浏览抓取结果与最佳/最差城市。
  - 柱状图：AQI 从优到劣的直观排序。
  - 单城趋势：月份折线展示 AQI 变化。
  - 月份 Top20：指定月份的前 20 城市柱状对比。
  - 双城对比：任意两城的月度趋势对比折线。

## 实现思路
1. **分层解耦**：MVC 结构将抓取解析（Model）、流程编排（Controller）与呈现（View）分离，便于复用与测试。
2. **稳健抓取**：统一 Session headers、遵守 `robots.txt`、请求节流；异常时使用内置示例数据保证功能可演示。
3. **数据管线**：
   - 抓取首页城市 AQI -> 解析为 `CityAQI` 列表 -> 转 DataFrame。
   - 按城市抓取月度表 -> 拼接为总表 -> 持久化 CSV。
   - 控制器提供排序与 TopN 汇总，视图按需选择列与顺序绘图。
4. **交互与展示**：Streamlit 侧边栏控制抓取规模与排行数；Altair 负责可视化，颜色编码区分空气质量好坏；下拉框提供城市/月选择与双城对比。

